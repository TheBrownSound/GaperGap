var Utils=function(){var e={};return e.getTotalSpeed=function(e,t){return Math.sqrt(e*e+t*t)},e.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},e.getRandomFloat=function(e,t){return Math.random()*(t-e)+e},e.yesNo=function(){return 1==this.getRandomInt(0,1)?!0:!1},e.removeFromArray=function(e,t){var n=e.indexOf(t);return n>=0?(e.splice(t,1),!0):!1},e},Game=function(){function e(){var e=GaperGap.utils.getTotalSpeed(a.speed.x,a.speed.y);document.getElementById("speed").innerHTML="Speed: "+Math.round(e),n(e>10?.5:e>6?.75:1)}function t(){s||(a.update(),o.update(),i.update()),d>0?(o.y=d,d+=a.speed.y):0>d&&(d=0,o.y=0)}function n(e,t){t?o.scaleX=o.scaleY=e:e!=o.scaleX&&createjs.Tween.get(o,{override:!0}).to({scaleX:e,scaleY:e},4e3,createjs.Ease.sineOut)}var r=new createjs.Container,a=new Player,o=new Hill(a),i=new Score(a),s=!1,d=120;r.addChild(o);setInterval(t,Math.floor(1e3/60)),setInterval(e,500);return r.reset=function(){d=120,a.reset(),o.reset(),i.reset(),n(1,!0)},a.addEventListener("crash",function(){GaperGap.showMessage("Press enter to restart."),s=!0}),GaperGap.addEventListener("onKeyDown",function(e){if(!s)switch(e.key){case 32:a.squat();break;case"touch-left":case 37:a.turnRight();break;case 38:a.tuckDown(!0);break;case"touch-right":case 39:a.turnLeft();break;case 40:a.scrubSpeed(!0);break;default:console.log("unhandled keydown! - ",e.key)}}),GaperGap.addEventListener("onKeyUp",function(e){if(s)return void(13===e.key&&(r.reset(),s=!1,GaperGap.hideMessage()));switch(e.key){case 32:a.jump();break;case"touch-left":case"touch-right":case 37:case 39:a.stopTurning();break;case 38:a.tuckDown(!1);break;case 40:a.scrubSpeed(!1);break;default:console.log("unhandled keyup! - ",e.key)}}),GaperGap.addEventListener("stageResized",function(e){console.log("stageResized",e),r.x=e.width/2,r.y=e.height/2,o.width=e.width,o.height=e.height}),r},Score=function(e){function t(e){console.log("Score:add - ",e),o+=e,s.html(o)}var n,r,a={},o=0,i=$("#score"),s=$("#score .board");return i.addClass("show"),e.addEventListener("hit",function(e){if("tree"==e.target.type){var n=new ScoreSlug("Treehugger",t);n.addScore(50),t(n.amount),n.done()}}),a.reset=function(){o=0,t(0)},a.update=function(){e.airborne?r?r.addScore(2):r=new ScoreSlug("Air",t):r&&(r.done(),t(r.amount),r=!1);var a=GaperGap.utils.getTotalSpeed(e.speed.x,e.speed.y);a>10?n?n.addScore(1):n=new ScoreSlug("Speedy McSpeederson",t):n&&(n.done(),t(n.amount),n=!1)},a},ScoreSlug=function(e,t){var n={},r=0,a=$('<div class="slug">'+e+' <span class="points">+0</span></div>');return a.appendTo($("#score")),a.animate({marginTop:"10px",opacity:1},500),n.addScore=function(e){r+=e;var t=0>r?"":"+";a.find(".points").html(t+r)},n.done=function(){setTimeout(function(){a.animate({marginTop:"-60px",opacity:0},500,function(){t(r),a.remove()})},1e3)},n.__defineGetter__("amount",function(){return r}),n},Shred=function(e){var t=new createjs.Shape,n=t.graphics;return n.beginFill("#FFF"),n.drawCircle(0,0,e),n.endFill(),t.animate=function(e,n){createjs.Tween.get(t,{override:!0}).to({x:t.x+e,y:t.y+n,alpha:0},700,createjs.Ease.sineOut)},t},Skier=function(){var e=0,t=0,n=!1,r=new createjs.Container,a={rotation:0,y:-32},o={rotation:0,y:-40},i=new createjs.Container;i.y=a.y;var s={images:[GaperGap.assets.gabe],frames:{width:100,height:114}},d=new createjs.SpriteSheet(s),c=new createjs.Sprite(d);c.regX=s.frames.width/2,c.regY=.7*s.frames.height,c.y=o.y,c.gotoAndStop(0);var u={images:[GaperGap.assets["body-sprite"]],frames:{width:140,height:140}},p=new createjs.SpriteSheet(u),g=new createjs.Sprite(p);g.regX=u.frames.width/2,g.regY=u.frames.height/2+6,g.gotoAndStop(0);var h={images:[GaperGap.assets["pants-sprite"]],frames:{width:80,height:56}},l=new createjs.SpriteSheet(h),f=new createjs.Sprite(l);f.regX=h.frames.width/2,f.y=-h.frames.height+14,f.gotoAndStop(2);var w={images:[GaperGap.assets["ski-sprite"]],frames:{width:40,height:120}},_=new createjs.SpriteSheet(w),y=new createjs.Sprite(_),m=new createjs.Sprite(_);return y.regX=m.regX=w.frames.width/2,y.regY=m.regY=w.frames.height/2-8,y.gotoAndStop(2),m.gotoAndStop(2),i.addChild(g,c),r.addChild(y,m,f,i),r.turn=function(e){var t=10;switch(e){case"left":createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation+t},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation-t},100,createjs.Ease.linear);break;case"right":createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation-t},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation+t},100,createjs.Ease.linear);break;default:createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation},100,createjs.Ease.linear)}},r.squat=function(e){i.y=e?a.y+4:a.y},r.tuck=function(e){n=e,n?(i.y=a.y+4,c.y=o.y+2,g.gotoAndStop(1)):(i.y=a.y,c.y=o.y,g.gotoAndStop(0))},r.cross=function(){},r.crash=function(n){"tree"===n&&(t=-40,this.angle=e)},r.reset=function(e){r.squat(!1),r.tuck(!1),t=0,r.angle=e},r.__defineGetter__("crossed",function(){return t}),r.__defineSetter__("angle",function(r){e=r,-90>e||e>90?(g.gotoAndStop(2),c.gotoAndStop(1)):(g.gotoAndStop(n?1:0),c.gotoAndStop(0)),y.rotation=e-t,m.rotation=e+t;var a=-90>e||e>90?2:0,o=e*Math.PI/180;return o=Math.abs(e)>90?o:.7*o,y.x=-20*Math.cos(o),y.y=-8*Math.sin(o)-a,m.x=20*Math.cos(o),m.y=8*Math.sin(o)-a,-150>e||e>150?(f.gotoAndStop(9),y.gotoAndStop(2),m.gotoAndStop(2)):-120>e?f.gotoAndStop(10):e>120?f.gotoAndStop(8):-90>e?(f.gotoAndStop(11),y.gotoAndStop(3),m.gotoAndStop(3)):e>90?(f.gotoAndStop(7),y.gotoAndStop(1),m.gotoAndStop(1)):-70>e?(f.gotoAndStop(6),y.gotoAndStop(4),m.gotoAndStop(4)):e>70?(f.gotoAndStop(0),y.gotoAndStop(0),m.gotoAndStop(0)):-50>e?(f.gotoAndStop(5),y.gotoAndStop(3),m.gotoAndStop(3)):e>50?(f.gotoAndStop(1),y.gotoAndStop(1),m.gotoAndStop(1)):-20>e?(f.gotoAndStop(4),y.gotoAndStop(3),m.gotoAndStop(3)):e>20?(f.gotoAndStop(2),y.gotoAndStop(1),m.gotoAndStop(1)):(f.gotoAndStop(3),y.gotoAndStop(2),m.gotoAndStop(2)),e}),r},Player=function(){function e(){var e=o.airborne?A:v;if(o.airborne?u=C:A!==!1&&((C>0&&Math.abs(e)>90||0>C&&Math.abs(e)<90)&&(u=-u),A=!1,C=0),_)u-=y;else{var n=90-Math.abs(e);n=Math.round(10*n)/1e3,u+=n}var r=g+t();u>r?u=r:-r>u&&(u=-r),p={x:Math.sin(e*Math.PI/180)*u,y:-(Math.cos(e*Math.PI/180)*u-k)}}function t(){return h&&w>l?l+=f:l>0&&(l-=f),l}function n(){("left"==m||!m&&S>0)&&a(),("right"==m||!m&&0>S)&&r();var e=4;return o.airborne?e=6:h&&(e=2),v+=S/c*e,-180>v?v=180:v>180&&(v=-180),v}function r(){S++,S>c&&(S=c)}function a(){S--,-c>S&&(S=-c)}var o=new createjs.Container,i=(createjs.EventDispatcher.initialize(o),new Skier),s=new createjs.Shape;s.graphics.beginFill("#000"),s.graphics.drawEllipse(0,0,60,30),s.graphics.endFill(),s.regX=30,s.regY=15,s.alpha=.5;var d=new createjs.Bitmap(GaperGap.assets["player-hitbox"]);d.regX=d.image.width/2,d.regY=d.image.height/2,d.alpha=0,o.scaleX=o.scaleY=.75,o.addChild(d,s,i);var c=10,u=0,p={x:0,y:0},g=8,h=!1,l=0,f=.2,w=4,_=!1,y=.2,m=null,v=-90,S=0,G=0,j=0,k=0,b=.2,A=!1,C=0,x=!1;return o.tuckDown=function(e){h=e,i.tuck(e)},o.scrubSpeed=function(e){_=e},o.turnLeft=function(){m="left",i.turn(m)},o.turnRight=function(){m="right",i.turn(m)},o.stopTurning=function(){m=!1,i.turn(m)},o.squat=function(){x=!0,i.squat(!0)},o.jump=function(e){e=e||0,x&&(e+=2,x=!1,i.squat(!1)),o.airborne||(A=v,C=u,k=e,o.dispatchEvent("jump"))},o.drop=function(e){o.airborne||(A=v,C=u),j=e},o.crash=function(e){e=e||"",i.crash(e),u=0,o.dispatchEvent("crash")},o.hit=function(e){o.dispatchEvent("hit",e)},o.reset=function(){u=S=p.x=p.y=0,m=null,x=!1,i.reset(-90),v=-90},o.update=function(){var t=n();i.angle=t,(k>0||G>0||j>0)&&((k>0||G>0)&&(G+=k,0>=G&&(G=0),o.scaleX=o.scaleY=G/300+.75),k-=b,j>0&&(j+=k,0>=j&&(j=0)),0===G&&0===j&&(console.log("land!"),k=0,o.dispatchEvent("land"))),s.y=G+j,s.alpha=s.y>0?s.y/1e3:0,e()},o.__defineGetter__("speed",function(){return p}),o.__defineGetter__("maxSpeed",function(){return g+w}),o.__defineGetter__("airborne",function(){return G>0||j>0}),o.__defineGetter__("hitArea",function(){return d}),o},Hill=function(e){function t(){var e=2*c+2*u;f.graphics.clear(),f.graphics.beginBitmapFill(GaperGap.assets["hill-background"]),f.graphics.drawRect(-e,-e,2*e,2*e),f.graphics.endFill()}function n(e,t){console.log("Hill:addSection - ",e,t);var n=new Section(p,g,{x:e*p,y:t*p});n.x=e*p,n.y=t*p,h[e+"_"+t]=n,w.addChild(n.foreground),y.addChild(n.background)}function r(e){w.removeChild(e.foreground),y.removeChild(e.background)}function a(){console.log("player Jumped"),l.addChild(e)}function o(){console.log("player Landed"),l.addChildAt(e,l.getChildIndex(y)+1)}function i(){for(var e=-s-c/2,t=-d-u/2,n=[],r=Math.floor(e/p),a=Math.floor(t/p),o=Math.ceil(c/p)+1,i=Math.ceil(u/p)+1,g=0;o*i>g;g++){var h=g%o+r,l=Math.floor(g/o)+a;n.push({column:h,row:l})}return n}var s=0,d=0,c=300,u=300,p=1e3,g=6,h={},l=new createjs.Container,f=new createjs.Shape,w=new createjs.Container,_=new createjs.Container,y=new createjs.Container,m=new createjs.Bitmap(GaperGap.assets.logo);return m.regX=m.image.width/2,m.regY=340,l.addChild(f,y,_,e,w,m),e.addEventListener("jump",a),e.addEventListener("land",o),l.update=function(){f.x=(f.x+e.speed.x)%400,f.y=(f.y+e.speed.y)%400,m.x=_.x+=e.speed.x,m.y=_.y+=e.speed.y,s+=e.speed.x,d+=e.speed.y;var t=({col:Math.floor(-s/p),row:Math.floor(-d/p)},i());for(var a in t){var o=t[a];h[o.column+"_"+o.row]||n(o.column,o.row)}for(var c in h){var g=h[c];if(g.y+p<-u/2)console.log("removing section"),r(g),delete h[c];else{var l=g.features;for(var w in l){var y=l[w],v=ndgmr.checkPixelCollision(e.hitArea,y.hitArea,0,!0);v&&y.hit(e,v)}}g.x=g.location.x+s,g.y=g.location.y+d}},l.reset=function(){for(var e in h)r(h[e]),delete h[e];m.x=_.x=m.y=_.y=s=d=0,l.update()},l.__defineSetter__("height",function(e){return u=e}),l.__defineGetter__("height",function(){return u}),l.__defineSetter__("width",function(e){return c=e}),l.__defineGetter__("width",function(){return c}),l.__defineGetter__("distance",function(){return Math.round(-d)}),t(),l},Section=function(e,t,n){function r(){var e=GaperGap.utils.getRandomInt(0,10);switch(e){case 1:return new Cliff;case 2:return new Jump;default:return new Tree}}function a(e,t){return e.y>t.y?1:e.y<t.y?-1:0}t=t||10;var o={},i=0,s=0,d={x:n.x||0,y:n.y||0};console.log("coords:",n);var c=[],u=new createjs.Container,p=new createjs.Container,g=new createjs.Shape;if(n.y>=0){for(;c.length<t;){var h=r();h.x=GaperGap.utils.getRandomInt(0,e),h.y=GaperGap.utils.getRandomInt(0,e),c.push(h),h.background&&p.addChild(h.background),h.foreground&&u.addChild(h.foreground)}p.sortChildren(a),u.sortChildren(a)}else{var l=new createjs.Bitmap(GaperGap.assets.sky);p.addChild(l)}return o.drawTrack=function(e,t){g.graphics.beginFill("#000").drawCircle(e,t,4).endFill()},o.__defineGetter__("foreground",function(){return u}),o.__defineGetter__("background",function(){return p}),o.__defineGetter__("features",function(){return c}),o.__defineGetter__("location",function(){return d}),o.__defineSetter__("x",function(e){return i=u.x=p.x=e}),o.__defineGetter__("x",function(){return i}),o.__defineSetter__("y",function(e){s=u.y=p.y=e;for(var t=u.globalToLocal(GaperGap.width/2,GaperGap.height/2),n=0;n<u.getNumChildren();n++){var r=u.getChildAt(n);r.y<t.y&&p.addChild(r)}return s}),o.__defineGetter__("y",function(){return s}),o},Tree=function(){var e=!1,t=new createjs.Container;t.type="tree";var n=new createjs.Bitmap(GaperGap.assets["tree-"+GaperGap.utils.getRandomInt(1,3)]),r=new createjs.Bitmap(GaperGap.assets["trunk-"+GaperGap.utils.getRandomInt(1,2)]),a=new createjs.Bitmap(GaperGap.assets["trunk-hitbox"]);return a.alpha=0,t.addChild(a,r,n),a.regX=a.image.width/2,a.regY=a.image.height,r.regX=r.image.width/2,r.regY=r.image.height,n.regX=n.image.width/2,n.regY=.8*n.image.height,n.y=-r.image.height,t.hit=function(a,o){if(!a.airborne&&o.width>25&&a.crash("tree"),!e){a.hit(t);var i=r.globalToLocal(o.x,o.y),s=i.x-r.image.width/2;createjs.Tween.get(n,{override:!1}).to({rotation:-s/2},100,createjs.Ease.circIn).to({rotation:-s/4},3e3,createjs.Ease.elasticOut),e=!0}},t.__defineGetter__("hitArea",function(){return a}),t.__defineGetter__("foreground",function(){return t}),t},Jump=function(){var e=new createjs.Container,t="s",n=.5,r=GaperGap.utils.getRandomInt(0,4);r>=4&&(t="m",n=.7);var a=new createjs.Bitmap(GaperGap.assets["jump-"+t]);return a.regX=a.image.width/2,e.addChild(a),e.hit=function(e){var t=Math.round(GaperGap.utils.getTotalSpeed(e.speed.x,e.speed.y)*n);e.jump(t),e.drop(a.image.height/2)},e.__defineGetter__("hitArea",function(){return a}),e.__defineGetter__("background",function(){return e}),e},Cliff=function(){var e=new createjs.Bitmap(GaperGap.assets["cliff-"+GaperGap.utils.getRandomInt(1,1)]);return e.regX=e.image.width/2,e.regY=e.image.height/2,e.hit=function(t,n){var r=e.globalToLocal(n.x,n.y);console.log("Cliff:hit - ",r.y),t.drop(e.image.height-r.y)},e.__defineGetter__("hitArea",function(){return e}),e.__defineGetter__("background",function(){return e}),e},GaperGap=function(){function e(e){console.log("handleFileLoad: ",e),u.push(e.item)}function t(){console.log("Game:startGame"),c.assets={};for(var e=0;e<u.length;e++)c.assets[u[e].id]=i.getResult(u[e].id);console.log("Game.assets",c.assets),d=new Game;var t=$("#message");t.removeClass("initial"),t.removeClass("show"),s.addChild(d),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",o),n()}function n(){s.canvas.width=window.innerWidth,s.canvas.height=window.innerHeight,c.dispatchEvent({type:"stageResized",width:s.canvas.width,height:s.canvas.height})}function r(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyDown",key:e.keyCode})}}function a(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyUp",key:e.keyCode})}}function o(){s.update(),document.getElementById("fps").innerHTML=Math.round(createjs.Ticker.getMeasuredFPS())+" fps"}{var i,s,d,c={utils:new Utils},u=[];createjs.EventDispatcher.initialize(c)}return c.showMessage=function(e){messageBox.html(e),messageBox.addClass("show")},c.hideMessage=function(){messageBox.removeClass("show")},c.init=function(n){console.log("Game:init"),s=c.stage=new createjs.Stage(document.getElementById(n)),createjs.Touch.enable(s),s.enableMouseOver(10),s.mouseMoveOutside=!1,s.snapToPixelEnabled=!0,manifest=[{src:"gapergap_logo.png",id:"logo"},{src:"gaper_sprite.png",id:"gabe"},{src:"bodies.png",id:"body-sprite"},{src:"pants.png",id:"pants-sprite"},{src:"ski_sprite.png",id:"ski-sprite"},{src:"hitbox.png",id:"player-hitbox"},{src:"trunk_hit.png",id:"trunk-hitbox"},{src:"trunk_1.png",id:"trunk-1"},{src:"trunk_2.png",id:"trunk-2"},{src:"tree_1.png",id:"tree-1"},{src:"tree_2.png",id:"tree-2"},{src:"tree_3.png",id:"tree-3"},{src:"cliff_1.png",id:"cliff-1"},{src:"jump_small.png",id:"jump-s"},{src:"jump_medium.png",id:"jump-m"},{src:"hill_background.png",id:"hill-background"},{src:"sky.png",id:"sky"}],i=new createjs.LoadQueue(!0,"assets/"),i.on("complete",t),i.on("fileload",e),i.loadManifest(manifest,!0,"assets/")},c.__defineGetter__("height",function(){return s.canvas.height}),c.__defineGetter__("width",function(){return s.canvas.width}),$(document).ready(function(){console.log("DOCUMENT READY"),"ontouchstart"in window&&($("body").addClass("touch"),$("left-turn").bind("touchstart",function(){console.log("rawr"),c.dispatchEvent({type:"onKeyDown",key:"touch-left"})}).bind("touchend",function(){c.dispatchEvent({type:"onKeyUp",key:"touch-left"})}),$("right-turn").bind("touchstart",function(){c.dispatchEvent({type:"onKeyDown",key:"touch-right"})}).bind("touchend",function(){c.dispatchEvent({type:"onKeyUp",key:"touch-right"})})),window.onresize=n,window.onkeydown=r,window.onkeyup=a}),c}();