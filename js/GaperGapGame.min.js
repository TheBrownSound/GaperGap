var Utils=function(){var e={};return e.getTotalSpeed=function(e,t){return Math.sqrt(e*e+t*t)},e.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},e.getRandomFloat=function(e,t){return Math.random()*(t-e)+e},e.yesNo=function(){return 1==this.getRandomInt(0,1)?!0:!1},e.removeFromArray=function(e,t){var n=e.indexOf(t);return n>=0?(e.splice(t,1),!0):!1},e},Game=function(){function e(){var e=GaperGap.utils.getTotalSpeed(a.speed.x,a.speed.y);document.getElementById("speed").innerHTML="Speed: "+e,n(e>10?.5:e>6?.75:1)}function t(){a.update(),o.update(),i.traveled=o.distance,s>0?(o.y=s,s+=a.speed.y):0>s&&(s=0,o.y=0)}function n(e){e!=o.scaleX&&createjs.Tween.get(o,{override:!0}).to({scaleX:e,scaleY:e},4e3,createjs.Ease.sineOut)}var r=new createjs.Container,a=new Player,o=new Hill(a),i=new Score(a),s=120;r.addChild(o);setInterval(t,Math.floor(1e3/60)),setInterval(e,500);return GaperGap.addEventListener("onKeyDown",function(e){switch(e.key){case 32:a.squat();break;case 37:a.turnRight();break;case 38:a.tuckDown(!0);break;case 39:a.turnLeft();break;case 40:a.scrubSpeed(!0);break;default:console.log("unhandled keydown! - ",e.key)}}),GaperGap.addEventListener("onKeyUp",function(e){switch(e.key){case 32:a.jump(2);break;case 37:case 39:a.stopTurning();break;case 38:a.tuckDown(!1);break;case 40:a.scrubSpeed(!1);break;default:console.log("unhandled keyup! - ",e.key)}}),GaperGap.addEventListener("stageResized",function(e){console.log("stageResized",e),r.x=e.width/2,r.y=e.height/2,o.width=e.width,o.height=e.height}),r},Score=function(e){function t(e){r+=e,o.innerHTML="Score: "+r}var n={},r=0,a=0,o=document.getElementById("score");return n.__defineSetter__("traveled",function(n){var r=n-a,o=GaperGap.utils.getTotalSpeed(e.speed.x,e.speed.y);a=n;var i=Math.round(r*o/10);return t(i),a}),n},Shred=function(e){var t=new createjs.Shape,n=t.graphics;return n.beginFill("#FFF"),n.drawCircle(0,0,e),n.endFill(),t.animate=function(e,n){createjs.Tween.get(t,{override:!0}).to({x:t.x+e,y:t.y+n,alpha:0},700,createjs.Ease.sineOut)},t},Skier=function(){var e=0,t=!1,n=new createjs.Container,r={rotation:0,y:-32},a={rotation:0,y:-40},o=new createjs.Container;o.y=r.y;var i=new createjs.Bitmap(GaperGap.assets.gabe);i.regX=i.image.width/2,i.regY=.7*i.image.height,i.y=a.y;var s={images:[GaperGap.assets["body-sprite"]],frames:{width:140,height:140}},d=new createjs.SpriteSheet(s),c=new createjs.Sprite(d);c.regX=s.frames.width/2,c.regY=s.frames.height/2+6,c.gotoAndStop(0);var u={images:[GaperGap.assets["pants-sprite"]],frames:{width:80,height:56}},g=new createjs.SpriteSheet(u),p=new createjs.Sprite(g);p.regX=u.frames.width/2,p.y=-u.frames.height+14,p.gotoAndStop(2);var l={images:[GaperGap.assets["ski-sprite"]],frames:{width:40,height:120}},f=new createjs.SpriteSheet(l),h=new createjs.Sprite(f),_=new createjs.Sprite(f);return h.regX=_.regX=l.frames.width/2,h.regY=_.regY=l.frames.height/2-8,h.gotoAndStop(2),_.gotoAndStop(2),o.addChild(c,i),n.addChild(h,_,p,o),n.turn=function(e){var t=10;switch(e){case"left":createjs.Tween.get(o,{override:!0}).to({rotation:r.rotation+t},100,createjs.Ease.linear),createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation-t},100,createjs.Ease.linear);break;case"right":createjs.Tween.get(o,{override:!0}).to({rotation:r.rotation-t},100,createjs.Ease.linear),createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation+t},100,createjs.Ease.linear);break;default:createjs.Tween.get(o,{override:!0}).to({rotation:r.rotation},100,createjs.Ease.linear),createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation},100,createjs.Ease.linear)}},n.squat=function(e){o.y=e?r.y+4:r.y},n.tuck=function(e){e?(o.y=r.y+4,i.y=a.y+2,c.gotoAndStop(1)):(o.y=r.y,i.y=a.y,c.gotoAndStop(0))},n.cross=function(){},n.__defineGetter__("crossed",function(){return t}),n.__defineSetter__("angle",function(n){e=n;var r=t?40:0;h.rotation=e-r,_.rotation=e+r;var a=-90>e||e>90?10:0,o=e*Math.PI/180;return o=Math.abs(e)>90?o:.7*o,h.x=-20*Math.cos(o),h.y=-8*Math.sin(o)-a,_.x=20*Math.cos(o),_.y=8*Math.sin(o)-a,-150>e||e>150?(p.gotoAndStop(9),h.gotoAndStop(2),_.gotoAndStop(2)):-120>e?p.gotoAndStop(10):e>120?p.gotoAndStop(8):-90>e?(p.gotoAndStop(11),h.gotoAndStop(3),_.gotoAndStop(3)):e>90?(p.gotoAndStop(7),h.gotoAndStop(1),_.gotoAndStop(1)):-70>e?(p.gotoAndStop(6),h.gotoAndStop(4),_.gotoAndStop(4)):e>70?(p.gotoAndStop(0),h.gotoAndStop(0),_.gotoAndStop(0)):-50>e?(p.gotoAndStop(5),h.gotoAndStop(3),_.gotoAndStop(3)):e>50?(p.gotoAndStop(1),h.gotoAndStop(1),_.gotoAndStop(1)):-20>e?(p.gotoAndStop(4),h.gotoAndStop(3),_.gotoAndStop(3)):e>20?(p.gotoAndStop(2),h.gotoAndStop(1),_.gotoAndStop(1)):(p.gotoAndStop(3),h.gotoAndStop(2),_.gotoAndStop(2)),e}),n},Player=function(){function e(){var e=o.airborne?x:v;if(w)u-=y;else{var n=85-Math.abs(e);n=Math.round(10*n)/1e3,u+=n;var r=p+t();u>r&&(u=r)}0>u&&(u=0),g={x:Math.sin(e*Math.PI/180)*u,y:-(Math.cos(e*Math.PI/180)*u-b)}}function t(){return l&&_>f?f+=h:f>0&&(f-=h),f}function n(){("left"==m||!m&&G>0)&&a(),("right"==m||!m&&0>G)&&r();var e=4;return o.airborne?e=6:l&&(e=2),v+=G/c*e,o.airborne?-180>v?v=180:v>180&&(v=-180):v>S?v=S:-S>v&&(v=-S),v}function r(){G++,G>c&&(G=c)}function a(){G--,-c>G&&(G=-c)}var o=new createjs.Container,i=(createjs.EventDispatcher.initialize(o),new Skier),s=new createjs.Shape;s.graphics.beginFill("#000"),s.graphics.drawEllipse(0,0,60,30),s.graphics.endFill(),s.regX=30,s.regY=15,s.alpha=.5;var d=new createjs.Bitmap(GaperGap.assets["player-hitbox"]);d.regX=d.image.width/2,d.regY=d.image.height/2,d.alpha=0,o.scaleX=o.scaleY=.75,o.addChild(d,s,i);var c=10,u=0,g={x:0,y:0},p=8,l=!1,f=0,h=.2,_=4,w=!1,y=.2,m=null,v=-90,G=0,S=90,j=0,k=0,b=0,A=.2,x=0;return o.tuckDown=function(e){l=e,i.tuck(e)},o.scrubSpeed=function(e){w=e},o.turnLeft=function(){m="left",i.turn(m)},o.turnRight=function(){m="right",i.turn(m)},o.stopTurning=function(){m=!1,i.turn(m)},o.squat=function(){i.squat(!0)},o.jump=function(e){i.squat(!1),o.airborne||(x=v,b=e,o.dispatchEvent("jump"))},o.drop=function(e){o.airborne||(x=v),k=e},o.crash=function(){u=0},o.update=function(){var t=n();i.angle=t,(b>0||j>0||k>0)&&((b>0||j>0)&&(j+=b,0>=j&&(j=0),o.scaleX=o.scaleY=j/100+.75),b-=A,k>0&&(k+=b,0>=k&&(k=0)),0===j&&0===k&&(console.log("land!"),b=0,o.dispatchEvent("land"))),s.y=j+k,s.alpha=s.y>0?s.y/1e3:0,e()},o.__defineGetter__("speed",function(){return g}),o.__defineGetter__("maxSpeed",function(){return p+_}),o.__defineGetter__("airborne",function(){return j>0||k>0}),o.__defineGetter__("hitArea",function(){return d}),o},Hill=function(e){function t(){var e=2*c+2*u;h.graphics.clear(),h.graphics.beginBitmapFill(GaperGap.assets["hill-background"]),h.graphics.drawRect(-e,-e,2*e,2*e),h.graphics.endFill()}function n(e,t){console.log("Hill:addSection - ",e,t);var n=new Section(g,p,{x:e*g,y:t*g});n.x=e*g,n.y=t*g,l[e+"_"+t]=n,_.addChild(n.foreground),y.addChild(n.background)}function r(e){_.removeChild(e.foreground),y.removeChild(e.background)}function a(){console.log("player Jumped"),f.addChild(e)}function o(){console.log("player Landed"),f.addChildAt(e,f.getChildIndex(_))}function i(){for(var e=-s-c/2,t=-d-u/2,n=[],r=Math.floor(e/g),a=Math.floor(t/g),o=Math.ceil(c/g)+1,i=Math.ceil(u/g)+1,p=0;o*i>p;p++){var l=p%o+r,f=Math.floor(p/o)+a;n.push({column:l,row:f})}return n}var s=0,d=0,c=300,u=300,g=1e3,p=6,l={},f=new createjs.Container,h=new createjs.Shape,_=new createjs.Container,w=new createjs.Container,y=new createjs.Container,m=new createjs.Bitmap(GaperGap.assets.logo);return m.regX=m.image.width/2,m.regY=340,f.addChild(h,y,w,e,_,m),e.addEventListener("jump",a),e.addEventListener("land",o),f.update=function(){h.x=(h.x+e.speed.x)%400,h.y=(h.y+e.speed.y)%400,m.x=w.x+=e.speed.x,m.y=w.y+=e.speed.y,s+=e.speed.x,d+=e.speed.y;var t=({col:Math.floor(-s/g),row:Math.floor(-d/g)},i());for(var a in t){var o=t[a];l[o.column+"_"+o.row]||n(o.column,o.row)}for(var c in l){var p=l[c];if(p.y+g<-u/2)console.log("removing section"),r(p),delete l[c];else{var f=p.features;for(var _ in f){var y=ndgmr.checkPixelCollision(e.hitArea,f[_].hitArea,0,!0);y&&f[_].hit(e,y)}}p.x=p.location.x+s,p.y=p.location.y+d}},f.__defineSetter__("height",function(e){return u=e}),f.__defineGetter__("height",function(){return u}),f.__defineSetter__("width",function(e){return c=e}),f.__defineGetter__("width",function(){return c}),f.__defineGetter__("distance",function(){return Math.round(-d)}),t(),f},Section=function(e,t,n){function r(){var e=GaperGap.utils.getRandomInt(0,10);switch(e){case 1:return new Cliff;case 2:return new Jump;default:return new Tree}}function a(e,t){return e.y>t.y?1:e.y<t.y?-1:0}t=t||10;var o={},i=0,s=0,d={x:n.x||0,y:n.y||0};console.log("coords:",n);var c=[],u=new createjs.Container,g=new createjs.Container,p=new createjs.Shape;if(n.y>=0){for(;c.length<t;){var l=r();l.x=GaperGap.utils.getRandomInt(0,e),l.y=GaperGap.utils.getRandomInt(0,e),c.push(l),l.background&&g.addChild(l.background),l.foreground&&u.addChild(l.foreground)}g.sortChildren(a),u.sortChildren(a)}else{var f=new createjs.Bitmap(GaperGap.assets.sky);g.addChild(f)}return o.drawTrack=function(e,t){p.graphics.beginFill("#000").drawCircle(e,t,4).endFill()},o.__defineGetter__("foreground",function(){return u}),o.__defineGetter__("background",function(){return g}),o.__defineGetter__("features",function(){return c}),o.__defineGetter__("location",function(){return d}),o.__defineSetter__("x",function(e){return i=u.x=g.x=e}),o.__defineGetter__("x",function(){return i}),o.__defineSetter__("y",function(e){return s=u.y=g.y=e}),o.__defineGetter__("y",function(){return s}),o},Tree=function(){var e=!1,t={},n=new createjs.Container,r=new createjs.Bitmap(GaperGap.assets["trunk-"+GaperGap.utils.getRandomInt(1,2)]),a=new createjs.Bitmap(GaperGap.assets["tree-"+GaperGap.utils.getRandomInt(1,3)]);return n.addChild(a),r.regX=r.image.width/2,r.regY=r.image.height,n.regY=r.image.height,a.regX=a.image.width/2,a.regY=.8*a.image.height,a.scaleX=GaperGap.utils.yesNo()?1:-1,t.hit=function(t,a){var o=r.globalToLocal(a.x,a.y),i=-(o.x-r.image.width/2);!t.airborne&&Math.abs(i)<10&&t.crash(),e||(createjs.Tween.get(n,{override:!1}).to({rotation:i/2},100,createjs.Ease.circIn).to({rotation:i/4},3e3,createjs.Ease.elasticOut),e=!0)},t.__defineGetter__("hitArea",function(){return r}),t.__defineGetter__("foreground",function(){return n}),t.__defineGetter__("background",function(){return r}),t.__defineSetter__("x",function(e){return _x=r.x=n.x=e}),t.__defineGetter__("x",function(){return _x}),t.__defineSetter__("y",function(e){return _y=r.y=e,n.y=e-20,_y}),t.__defineGetter__("y",function(){return _y}),t},Jump=function(){var e=new createjs.Container,t=new createjs.Bitmap(GaperGap.assets.jump);return t.regX=t.image.width/2,e.hit=function(e){e.jump(5),e.drop(t.image.height/2)},e.__defineGetter__("hitArea",function(){return t}),e.addChild(t),e.__defineGetter__("background",function(){return e}),e},Cliff=function(){var e=new createjs.Bitmap(GaperGap.assets["cliff-"+GaperGap.utils.getRandomInt(1,1)]);return e.regX=e.image.width/2,e.regY=e.image.height/2,e.hit=function(t,n){var r=e.globalToLocal(n.x,n.y);console.log("Cliff:hit - ",r.y),t.drop(e.image.height-r.y)},e.__defineGetter__("hitArea",function(){return e}),e.__defineGetter__("background",function(){return e}),e},GaperGap=function(){function e(e){console.log("handleFileLoad: ",e),u.push(e.item)}function t(){console.log("Game:startGame"),c.assets={};for(var e=0;e<u.length;e++)c.assets[u[e].id]=i.getResult(u[e].id);console.log("Game.assets",c.assets),d=new Game,s.addChild(d),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",o),n()}function n(){s.canvas.width=window.innerWidth,s.canvas.height=window.innerHeight,c.dispatchEvent({type:"stageResized",width:s.canvas.width,height:s.canvas.height})}function r(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyDown",key:e.keyCode})}}function a(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyUp",key:e.keyCode})}}function o(){s.update(),document.getElementById("fps").innerHTML=Math.round(createjs.Ticker.getMeasuredFPS())+" fps"}{var i,s,d,c={utils:new Utils},u=[];createjs.EventDispatcher.initialize(c)}return c.init=function(n){console.log("Game:init"),s=c.stage=new createjs.Stage(document.getElementById(n)),createjs.Touch.enable(s),s.enableMouseOver(10),s.mouseMoveOutside=!1,s.snapToPixelEnabled=!0,manifest=[{src:"gapergap_logo.png",id:"logo"},{src:"gaper_gabe.png",id:"gabe"},{src:"bodies.png",id:"body-sprite"},{src:"pants.png",id:"pants-sprite"},{src:"ski_sprite.png",id:"ski-sprite"},{src:"hitbox.png",id:"player-hitbox"},{src:"trunk_1.png",id:"trunk-1"},{src:"trunk_2.png",id:"trunk-2"},{src:"tree_1.png",id:"tree-1"},{src:"tree_2.png",id:"tree-2"},{src:"tree_3.png",id:"tree-3"},{src:"cliff_1.png",id:"cliff-1"},{src:"jump.png",id:"jump"},{src:"hill_background.png",id:"hill-background"},{src:"sky.png",id:"sky"}],i=new createjs.LoadQueue(!0,"assets/"),i.on("complete",t),i.on("fileload",e),i.loadManifest(manifest,!0,"assets/")},c.__defineGetter__("height",function(){return s.canvas.height}),c.__defineGetter__("width",function(){return s.canvas.width}),$(document).ready(function(){console.log("DOCUMENT READY"),window.onresize=n,window.onkeydown=r,window.onkeyup=a}),c}();