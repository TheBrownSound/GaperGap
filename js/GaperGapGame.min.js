var Utils=function(){var e={};return e.getTotalSpeed=function(e,t){return Math.sqrt(e*e+t*t)},e.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},e.getRandomFloat=function(e,t){return Math.random()*(t-e)+e},e.yesNo=function(){return 1==this.getRandomInt(0,1)?!0:!1},e.removeFromArray=function(e,t){var n=e.indexOf(t);return n>=0?(e.splice(t,1),!0):!1},e},Game=function(){function e(){var e=GaperGap.utils.getTotalSpeed(a.speed.x,a.speed.y);document.getElementById("speed").innerHTML="Speed: "+e,n(e>10?.5:e>6?.75:1)}function t(){s||(a.update(),o.update(),i.update()),d>0?(o.y=d,d+=a.speed.y):0>d&&(d=0,o.y=0)}function n(e,t){t?o.scaleX=o.scaleY=e:e!=o.scaleX&&createjs.Tween.get(o,{override:!0}).to({scaleX:e,scaleY:e},4e3,createjs.Ease.sineOut)}var r=new createjs.Container,a=new Player,o=new Hill(a),i=new Score(a),s=!1,d=120;r.addChild(o);setInterval(t,Math.floor(1e3/60)),setInterval(e,500);return r.reset=function(){d=120,a.reset(),o.reset(),i.reset(),n(1,!0)},a.addEventListener("crash",function(){s=!0}),GaperGap.addEventListener("onKeyDown",function(e){if(!s)switch(e.key){case 32:a.squat();break;case"touch-left":case 37:a.turnRight();break;case 38:a.tuckDown(!0);break;case"touch-right":case 39:a.turnLeft();break;case 40:a.scrubSpeed(!0);break;default:console.log("unhandled keydown! - ",e.key)}}),GaperGap.addEventListener("onKeyUp",function(e){if(s)return r.reset(),void(s=!1);switch(e.key){case 32:a.jump();break;case"touch-left":case"touch-right":case 37:case 39:a.stopTurning();break;case 38:a.tuckDown(!1);break;case 40:a.scrubSpeed(!1);break;default:console.log("unhandled keyup! - ",e.key)}}),GaperGap.addEventListener("stageResized",function(e){console.log("stageResized",e),r.x=e.width/2,r.y=e.height/2,o.width=e.width,o.height=e.height}),r},Score=function(e){function t(e){r+=e,d.html(r)}var n={},r=0,a=0,o=0,i=0,s=$("#score"),d=$("#score .box");return s.addClass("show"),e.addEventListener("hit",function(e){"tree"==e.target.type&&t(50,"Treehugger")}),n.reset=function(){r=0,t(0)},n.update=function(){e.airborne?a++:a>0&&(t(a),a=0);var n=GaperGap.utils.getTotalSpeed(e.speed.x,e.speed.y);n>10?(o++,i=o*o):o>0&&(o=0,t(i),i=0)},n},Shred=function(e){var t=new createjs.Shape,n=t.graphics;return n.beginFill("#FFF"),n.drawCircle(0,0,e),n.endFill(),t.animate=function(e,n){createjs.Tween.get(t,{override:!0}).to({x:t.x+e,y:t.y+n,alpha:0},700,createjs.Ease.sineOut)},t},Skier=function(){var e=0,t=!1,n=!1,r=new createjs.Container,a={rotation:0,y:-32},o={rotation:0,y:-40},i=new createjs.Container;i.y=a.y;var s={images:[GaperGap.assets.gabe],frames:{width:100,height:114}},d=new createjs.SpriteSheet(s),c=new createjs.Sprite(d);c.regX=s.frames.width/2,c.regY=.7*s.frames.height,c.y=o.y,c.gotoAndStop(0);var u={images:[GaperGap.assets["body-sprite"]],frames:{width:140,height:140}},p=new createjs.SpriteSheet(u),g=new createjs.Sprite(p);g.regX=u.frames.width/2,g.regY=u.frames.height/2+6,g.gotoAndStop(0);var h={images:[GaperGap.assets["pants-sprite"]],frames:{width:80,height:56}},f=new createjs.SpriteSheet(h),l=new createjs.Sprite(f);l.regX=h.frames.width/2,l.y=-h.frames.height+14,l.gotoAndStop(2);var _={images:[GaperGap.assets["ski-sprite"]],frames:{width:40,height:120}},y=new createjs.SpriteSheet(_),w=new createjs.Sprite(y),v=new createjs.Sprite(y);return w.regX=v.regX=_.frames.width/2,w.regY=v.regY=_.frames.height/2-8,w.gotoAndStop(2),v.gotoAndStop(2),i.addChild(g,c),r.addChild(w,v,l,i),r.turn=function(e){var t=10;switch(e){case"left":createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation+t},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation-t},100,createjs.Ease.linear);break;case"right":createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation-t},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation+t},100,createjs.Ease.linear);break;default:createjs.Tween.get(i,{override:!0}).to({rotation:a.rotation},100,createjs.Ease.linear),createjs.Tween.get(c,{override:!0}).to({rotation:o.rotation},100,createjs.Ease.linear)}},r.squat=function(e){i.y=e?a.y+4:a.y},r.tuck=function(e){n=e,n?(i.y=a.y+4,c.y=o.y+2,g.gotoAndStop(1)):(i.y=a.y,c.y=o.y,g.gotoAndStop(0))},r.cross=function(){},r.reset=function(e){r.squat(!1),r.tuck(!1),r.angle=e},r.__defineGetter__("crossed",function(){return t}),r.__defineSetter__("angle",function(r){e=r,-90>e||e>90?(g.gotoAndStop(2),c.gotoAndStop(1)):(g.gotoAndStop(n?1:0),c.gotoAndStop(0));var a=t?40:0;w.rotation=e-a,v.rotation=e+a;var o=-90>e||e>90?2:0,i=e*Math.PI/180;return i=Math.abs(e)>90?i:.7*i,w.x=-20*Math.cos(i),w.y=-8*Math.sin(i)-o,v.x=20*Math.cos(i),v.y=8*Math.sin(i)-o,-150>e||e>150?(l.gotoAndStop(9),w.gotoAndStop(2),v.gotoAndStop(2)):-120>e?l.gotoAndStop(10):e>120?l.gotoAndStop(8):-90>e?(l.gotoAndStop(11),w.gotoAndStop(3),v.gotoAndStop(3)):e>90?(l.gotoAndStop(7),w.gotoAndStop(1),v.gotoAndStop(1)):-70>e?(l.gotoAndStop(6),w.gotoAndStop(4),v.gotoAndStop(4)):e>70?(l.gotoAndStop(0),w.gotoAndStop(0),v.gotoAndStop(0)):-50>e?(l.gotoAndStop(5),w.gotoAndStop(3),v.gotoAndStop(3)):e>50?(l.gotoAndStop(1),w.gotoAndStop(1),v.gotoAndStop(1)):-20>e?(l.gotoAndStop(4),w.gotoAndStop(3),v.gotoAndStop(3)):e>20?(l.gotoAndStop(2),w.gotoAndStop(1),v.gotoAndStop(1)):(l.gotoAndStop(3),w.gotoAndStop(2),v.gotoAndStop(2)),e}),r},Player=function(){function e(){var e=o.airborne?A:m;if(o.airborne?u=x:A!==!1&&((x>0&&Math.abs(e)>90||0>x&&Math.abs(e)<90)&&(u=-u),A=!1,x=0),y)u-=w;else{var n=90-Math.abs(e);n=Math.round(10*n)/1e3,u+=n}var r=g+t();u>r?u=r:-r>u&&(u=-r),p={x:Math.sin(e*Math.PI/180)*u,y:-(Math.cos(e*Math.PI/180)*u-k)}}function t(){return h&&_>f?f+=l:f>0&&(f-=l),f}function n(){("left"==v||!v&&S>0)&&a(),("right"==v||!v&&0>S)&&r();var e=4;return o.airborne?e=6:h&&(e=2),m+=S/c*e,-180>m?m=180:m>180&&(m=-180),m}function r(){S++,S>c&&(S=c)}function a(){S--,-c>S&&(S=-c)}var o=new createjs.Container,i=(createjs.EventDispatcher.initialize(o),new Skier),s=new createjs.Shape;s.graphics.beginFill("#000"),s.graphics.drawEllipse(0,0,60,30),s.graphics.endFill(),s.regX=30,s.regY=15,s.alpha=.5;var d=new createjs.Bitmap(GaperGap.assets["player-hitbox"]);d.regX=d.image.width/2,d.regY=d.image.height/2,d.alpha=0,o.scaleX=o.scaleY=.75,o.addChild(d,s,i);var c=10,u=0,p={x:0,y:0},g=8,h=!1,f=0,l=.2,_=4,y=!1,w=.2,v=null,m=-90,S=0,G=0,j=0,k=0,b=.2,A=!1,x=0,C=!1;return o.tuckDown=function(e){h=e,i.tuck(e)},o.scrubSpeed=function(e){y=e},o.turnLeft=function(){v="left",i.turn(v)},o.turnRight=function(){v="right",i.turn(v)},o.stopTurning=function(){v=!1,i.turn(v)},o.squat=function(){C=!0,i.squat(!0)},o.jump=function(e){e=e||0,C&&(e+=2,C=!1,i.squat(!1)),o.airborne||(A=m,x=u,k=e,o.dispatchEvent("jump"))},o.drop=function(e){o.airborne||(A=m,x=u),j=e},o.crash=function(){u=0,o.dispatchEvent("crash")},o.hit=function(e){o.dispatchEvent("hit",e)},o.reset=function(){u=S=p.x=p.y=0,v=null,C=!1,i.reset(-90),m=-90},o.update=function(){var t=n();i.angle=t,(k>0||G>0||j>0)&&((k>0||G>0)&&(G+=k,0>=G&&(G=0),o.scaleX=o.scaleY=G/100+.75),k-=b,j>0&&(j+=k,0>=j&&(j=0)),0===G&&0===j&&(console.log("land!"),k=0,o.dispatchEvent("land"))),s.y=G+j,s.alpha=s.y>0?s.y/1e3:0,e()},o.__defineGetter__("speed",function(){return p}),o.__defineGetter__("maxSpeed",function(){return g+_}),o.__defineGetter__("airborne",function(){return G>0||j>0}),o.__defineGetter__("hitArea",function(){return d}),o},Hill=function(e){function t(){var e=2*c+2*u;l.graphics.clear(),l.graphics.beginBitmapFill(GaperGap.assets["hill-background"]),l.graphics.drawRect(-e,-e,2*e,2*e),l.graphics.endFill()}function n(e,t){console.log("Hill:addSection - ",e,t);var n=new Section(p,g,{x:e*p,y:t*p});n.x=e*p,n.y=t*p,h[e+"_"+t]=n,_.addChild(n.foreground),w.addChild(n.background)}function r(e){_.removeChild(e.foreground),w.removeChild(e.background)}function a(){console.log("player Jumped"),f.addChild(e)}function o(){console.log("player Landed"),f.addChildAt(e,f.getChildIndex(_))}function i(){for(var e=-s-c/2,t=-d-u/2,n=[],r=Math.floor(e/p),a=Math.floor(t/p),o=Math.ceil(c/p)+1,i=Math.ceil(u/p)+1,g=0;o*i>g;g++){var h=g%o+r,f=Math.floor(g/o)+a;n.push({column:h,row:f})}return n}var s=0,d=0,c=300,u=300,p=1e3,g=6,h={},f=new createjs.Container,l=new createjs.Shape,_=new createjs.Container,y=new createjs.Container,w=new createjs.Container,v=new createjs.Bitmap(GaperGap.assets.logo);return v.regX=v.image.width/2,v.regY=340,f.addChild(l,w,y,e,_,v),e.addEventListener("jump",a),e.addEventListener("land",o),f.update=function(){l.x=(l.x+e.speed.x)%400,l.y=(l.y+e.speed.y)%400,v.x=y.x+=e.speed.x,v.y=y.y+=e.speed.y,s+=e.speed.x,d+=e.speed.y;var t=({col:Math.floor(-s/p),row:Math.floor(-d/p)},i());for(var a in t){var o=t[a];h[o.column+"_"+o.row]||n(o.column,o.row)}for(var c in h){var g=h[c];if(g.y+p<-u/2)console.log("removing section"),r(g),delete h[c];else{var f=g.features;for(var _ in f){var w=ndgmr.checkPixelCollision(e.hitArea,f[_].hitArea,0,!0);w&&f[_].hit(e,w)}}g.x=g.location.x+s,g.y=g.location.y+d}},f.reset=function(){for(var e in h)r(h[e]),delete h[e];v.x=y.x=v.y=y.y=s=d=0,f.update()},f.__defineSetter__("height",function(e){return u=e}),f.__defineGetter__("height",function(){return u}),f.__defineSetter__("width",function(e){return c=e}),f.__defineGetter__("width",function(){return c}),f.__defineGetter__("distance",function(){return Math.round(-d)}),t(),f},Section=function(e,t,n){function r(){var e=GaperGap.utils.getRandomInt(0,10);switch(e){case 1:return new Cliff;case 2:return new Jump;default:return new Tree}}function a(e,t){return e.y>t.y?1:e.y<t.y?-1:0}t=t||10;var o={},i=0,s=0,d={x:n.x||0,y:n.y||0};console.log("coords:",n);var c=[],u=new createjs.Container,p=new createjs.Container,g=new createjs.Shape;if(n.y>=0){for(;c.length<t;){var h=r();h.x=GaperGap.utils.getRandomInt(0,e),h.y=GaperGap.utils.getRandomInt(0,e),c.push(h),h.background&&p.addChild(h.background),h.foreground&&u.addChild(h.foreground)}p.sortChildren(a),u.sortChildren(a)}else{var f=new createjs.Bitmap(GaperGap.assets.sky);p.addChild(f)}return o.drawTrack=function(e,t){g.graphics.beginFill("#000").drawCircle(e,t,4).endFill()},o.__defineGetter__("foreground",function(){return u}),o.__defineGetter__("background",function(){return p}),o.__defineGetter__("features",function(){return c}),o.__defineGetter__("location",function(){return d}),o.__defineSetter__("x",function(e){return i=u.x=p.x=e}),o.__defineGetter__("x",function(){return i}),o.__defineSetter__("y",function(e){return s=u.y=p.y=e}),o.__defineGetter__("y",function(){return s}),o},Tree=function(){var e=!1,t={};t.type="tree";var n=new createjs.Container,r=new createjs.Bitmap(GaperGap.assets["tree-"+GaperGap.utils.getRandomInt(1,3)]),a=new createjs.Container,o=new createjs.Bitmap(GaperGap.assets["trunk-"+GaperGap.utils.getRandomInt(1,2)]),i=new createjs.Bitmap(GaperGap.assets["trunk-hitbox"]);return i.alpha=0,a.addChild(i,o),n.addChild(r),i.regX=i.image.width/2,i.regY=i.image.height,o.regX=o.image.width/2,o.regY=o.image.height,n.regY=o.image.height,r.regX=r.image.width/2,r.regY=.8*r.image.height,t.hit=function(r,a){if(!r.airborne&&a.width>25&&r.crash(),!e){r.hit(t);var i=o.globalToLocal(a.x,a.y),s=i.x-o.image.width/2;createjs.Tween.get(n,{override:!1}).to({rotation:-s/2},100,createjs.Ease.circIn).to({rotation:-s/4},3e3,createjs.Ease.elasticOut),e=!0}},t.__defineGetter__("hitArea",function(){return i}),t.__defineGetter__("foreground",function(){return n}),t.__defineGetter__("background",function(){return a}),t.__defineSetter__("x",function(e){return _x=a.x=n.x=e}),t.__defineGetter__("x",function(){return _x}),t.__defineSetter__("y",function(e){return _y=a.y=e,n.y=e-20,_y}),t.__defineGetter__("y",function(){return _y}),t},Jump=function(){var e=new createjs.Container,t=new createjs.Bitmap(GaperGap.assets.jump);return t.regX=t.image.width/2,e.hit=function(e){var n=Math.round(.5*GaperGap.utils.getTotalSpeed(e.speed.x,e.speed.y));e.jump(n),e.drop(t.image.height/2)},e.__defineGetter__("hitArea",function(){return t}),e.addChild(t),e.__defineGetter__("background",function(){return e}),e},Cliff=function(){var e=new createjs.Bitmap(GaperGap.assets["cliff-"+GaperGap.utils.getRandomInt(1,1)]);return e.regX=e.image.width/2,e.regY=e.image.height/2,e.hit=function(t,n){var r=e.globalToLocal(n.x,n.y);console.log("Cliff:hit - ",r.y),t.drop(e.image.height-r.y)},e.__defineGetter__("hitArea",function(){return e}),e.__defineGetter__("background",function(){return e}),e},GaperGap=function(){function e(e){console.log("handleFileLoad: ",e),u.push(e.item)}function t(){console.log("Game:startGame"),c.assets={};for(var e=0;e<u.length;e++)c.assets[u[e].id]=i.getResult(u[e].id);console.log("Game.assets",c.assets),d=new Game,s.addChild(d),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",o),n()}function n(){s.canvas.width=window.innerWidth,s.canvas.height=window.innerHeight,c.dispatchEvent({type:"stageResized",width:s.canvas.width,height:s.canvas.height})}function r(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyDown",key:e.keyCode})}}function a(e){switch(e.keyCode){default:c.dispatchEvent({type:"onKeyUp",key:e.keyCode})}}function o(){s.update(),document.getElementById("fps").innerHTML=Math.round(createjs.Ticker.getMeasuredFPS())+" fps"}{var i,s,d,c={utils:new Utils},u=[];createjs.EventDispatcher.initialize(c)}return c.init=function(n){console.log("Game:init"),s=c.stage=new createjs.Stage(document.getElementById(n)),createjs.Touch.enable(s),s.enableMouseOver(10),s.mouseMoveOutside=!1,s.snapToPixelEnabled=!0,manifest=[{src:"gapergap_logo.png",id:"logo"},{src:"gaper_sprite.png",id:"gabe"},{src:"bodies.png",id:"body-sprite"},{src:"pants.png",id:"pants-sprite"},{src:"ski_sprite.png",id:"ski-sprite"},{src:"hitbox.png",id:"player-hitbox"},{src:"trunk_hit.png",id:"trunk-hitbox"},{src:"trunk_1.png",id:"trunk-1"},{src:"trunk_2.png",id:"trunk-2"},{src:"tree_1.png",id:"tree-1"},{src:"tree_2.png",id:"tree-2"},{src:"tree_3.png",id:"tree-3"},{src:"cliff_1.png",id:"cliff-1"},{src:"jump.png",id:"jump"},{src:"hill_background.png",id:"hill-background"},{src:"sky.png",id:"sky"}],i=new createjs.LoadQueue(!0,"assets/"),i.on("complete",t),i.on("fileload",e),i.loadManifest(manifest,!0,"assets/")},c.__defineGetter__("height",function(){return s.canvas.height}),c.__defineGetter__("width",function(){return s.canvas.width}),$(document).ready(function(){console.log("DOCUMENT READY"),"ontouchstart"in window&&($(body).addClass("touch"),$("left-turn").bind("touchstart",function(){c.dispatchEvent({type:"onKeyDown",key:"touch-left"})}).bind("touchend",function(){c.dispatchEvent({type:"onKeyUp",key:"touch-left"})}),$("right-turn").bind("touchstart",function(){c.dispatchEvent({type:"onKeyDown",key:"touch-right"})}).bind("touchend",function(){c.dispatchEvent({type:"onKeyUp",key:"touch-right"})})),window.onresize=n,window.onkeydown=r,window.onkeyup=a}),c}();